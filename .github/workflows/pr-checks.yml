# Pull Request Checks
# Additional checks for PRs to ensure code quality

name: PR Checks

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  # Job 1: PR Title Check
  pr-title-check:
    name: PR Title Check
    runs-on: ubuntu-latest

    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          scopes: |
            frontend
            backend
            docs
            ci
            deps
          requireScope: true
          subjectPattern: ^[A-Z].*$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with an uppercase character.

  # Job 2: Check for Merge Conflicts
  merge-conflict-check:
    name: Merge Conflict Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "Merge conflicts detected!"
            exit 1
          fi
          echo "No merge conflicts detected"

  # Job 3: Check for Large Files
  large-file-check:
    name: Large File Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for large files
        run: |
          max_size_kb=500
          large_files=$(find . -type f -size +${max_size_kb}k -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/pnpm-lock.yaml")

          if [ -n "$large_files" ]; then
            echo "Large files detected (>${max_size_kb}KB):"
            echo "$large_files"
            exit 1
          fi
          echo "No large files detected"

  # Job 4: Check for Secrets
  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 5: Dependency Review
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-3.0, AGPL-3.0

  # Job 6: Label PR
  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Label PR based on paths
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
