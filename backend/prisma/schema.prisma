// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  SUPER_ADMIN // Organization owner/admin
  BRANCH_ADMIN // Branch manager
  TEACHER
  STUDENT
  PARENT
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
  WITHDRAWN
  SUSPENDED
}

enum ParentLinkRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DocumentType {
  RESUME // Resume/CV
  CERTIFICATE // Teaching certificates, qualifications
  ID_DOCUMENT // Identity card, passport
  POLICE_CLEARANCE // Background check document
  CONTRACT // Employment contract
  DEGREE // Degree certificate
  OTHER // Other documents
}

enum LeaveType {
  SICK
  ANNUAL
  EMERGENCY
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum SubscriptionPlan {
  FREE_TRIAL // 14-day trial, up to 50 students
  STARTER // $49/month, up to 50 students, 1 branch
  PROFESSIONAL // $99/month, up to 200 students, 5 branches
  ENTERPRISE // Custom pricing, unlimited
}

enum PlanStatus {
  TRIAL // In free trial period
  ACTIVE // Active subscription
  PAST_DUE // Payment failed
  CANCELLED // Subscription cancelled
  SUSPENDED // Account suspended for non-payment
}

enum CourseCategory {
  UPSR // Primary School Achievement Test (Year 6)
  PT3 // Form 3 Assessment
  SPM // Malaysian Certificate of Education (Form 5)
  STPM // Malaysian Higher School Certificate (Form 6)
  MATRICULATION // Pre-University Matriculation
  IGCSE // International GCSE
  O_LEVEL // O-Level
  A_LEVEL // A-Level
  ACADEMIC // General Academic subjects
  ENRICHMENT // Art, Music, Coding, etc.
  LANGUAGE // Language courses
  SPECIAL_PROGRAM // Gifted, Remedial, Competition Prep
}

enum CourseLevel {
  STANDARD_1 // Primary Year 1
  STANDARD_2 // Primary Year 2
  STANDARD_3 // Primary Year 3
  STANDARD_4 // Primary Year 4
  STANDARD_5 // Primary Year 5
  STANDARD_6 // Primary Year 6 (UPSR)
  FORM_1 // Secondary Year 1
  FORM_2 // Secondary Year 2
  FORM_3 // Secondary Year 3 (PT3)
  FORM_4 // Secondary Year 4
  FORM_5 // Secondary Year 5 (SPM)
  FORM_6_LOWER // STPM Lower 6
  FORM_6_UPPER // STPM Upper 6
  MIXED // Mixed levels
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  MIXED
}

enum SessionDuration {
  THIRTY_MIN // 30 minutes
  FORTY_FIVE_MIN // 45 minutes
  SIXTY_MIN // 60 minutes (1 hour)
  NINETY_MIN // 90 minutes (1.5 hours)
  ONE_TWENTY_MIN // 120 minutes (2 hours)
}

enum ClassType {
  REGULAR_GROUP // Regular group class
  SMALL_GROUP // Small group (3-8 students)
  ONE_ON_ONE // Individual/private tutoring
  ONLINE // Online class
  HYBRID // In-person + online
  INTENSIVE // Intensive/crash course
  WORKSHOP // Workshop/seminar
}

enum ClassStatus {
  DRAFT // Not visible to students yet
  OPEN_FOR_ENROLLMENT // Accepting enrollments
  FULL // Capacity reached
  IN_PROGRESS // Term has started
  COMPLETED // Term ended
  CANCELLED // Class cancelled
  ON_HOLD // Temporarily suspended
}

enum EnrollmentStatus {
  ACTIVE // Currently enrolled
  COMPLETED // Completed the class
  WITHDRAWN // Withdrawn from class
  TRANSFERRED // Transferred to another class
  ON_LEAVE // Temporary leave
}

enum WaitlistStatus {
  WAITING // On waitlist
  OFFERED // Spot offered, awaiting response
  ACCEPTED // Accepted the offer
  DECLINED // Declined the offer
  EXPIRED // Offer expired
  ENROLLED // Successfully enrolled
  CANCELLED // Waitlist request cancelled
}

// Models

// Organization - Each tuition centre is a separate tenant
model Organization {
  id      Int     @id @default(autoincrement())
  name    String // "ABC Tuition Centre"
  slug    String  @unique // "abc-tuition" (for subdomain: abc-tuition.noesis.app)
  email   String  @unique
  phone   String?
  address String?

  // Subscription
  plan               SubscriptionPlan @default(FREE_TRIAL)
  planStatus         PlanStatus       @default(TRIAL)
  trialEndsAt        DateTime?
  subscriptionEndsAt DateTime?

  // Limits (enforced based on plan)
  maxStudents Int @default(50)
  maxBranches Int @default(1)

  // Branding
  logo         String?
  primaryColor String? @default("#3b82f6")

  // Settings
  timezone String  @default("Asia/Singapore")
  currency String  @default("SGD")
  country  String?

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users    User[]
  branches Branch[]
  students Student[]
  teachers Teacher[]
  courses  Course[]
  classes  Class[]
  rooms    Room[]
  fees     Fee[]
  invoices Invoice[]
  payments Payment[]

  @@index([slug])
  @@index([email])
  @@map("organizations")
}

model User {
  id       Int     @id @default(autoincrement())
  email    String // Email unique per organization
  password String
  name     String
  role     Role
  phone    String?
  address  String?
  isActive Boolean @default(true)

  // Personal Information
  dateOfBirth  DateTime?
  gender       String? // Male, Female, Other
  profilePhoto String? // URL to profile photo

  // Employee Information (for SUPER_ADMIN, BRANCH_ADMIN, TEACHER)
  employeeId          String?
  employmentStartDate DateTime?

  // Emergency Contact
  emergencyContactName  String?
  emergencyContactPhone String?

  // Multi-tenant: Each user belongs to an organization
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Branch assignment (required for BRANCH_ADMIN, optional for others)
  // SUPER_ADMIN: branchId = null (can access all branches)
  // BRANCH_ADMIN: branchId = specific branch (can only access that branch)
  // TEACHER/STUDENT/PARENT: branchId set via Teacher/Student model
  branchId Int?
  branch   Branch? @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - Optional based on role
  teacher               Teacher?
  student               Student?
  parent                Parent?
  approvedLinkRequests  ParentLinkRequest[]
  uploadedDocuments     Document[]
  reviewedLeaveRequests LeaveRequest[]

  @@unique([email, organizationId]) // Email unique per organization
  @@index([organizationId])
  @@index([branchId])
  @@index([email])
  @@map("users")
}

model Branch {
  id       Int     @id @default(autoincrement())
  name     String
  code     String // Branch code (unique per organization)
  address  String?
  phone    String?
  email    String?
  isActive Boolean @default(true)

  // Multi-tenant: Each branch belongs to an organization
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users          User[] // Branch admins and other users assigned to this branch
  students       Student[]
  teachers       Teacher[]
  classes        Class[]
  rooms          Room[]
  courseBranches CourseBranch[] // Courses offered at this branch

  @@unique([code, organizationId]) // Code unique per organization
  @@index([organizationId])
  @@map("branches")
}

model Student {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant: Each student belongs to an organization
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id])

  studentCode    String // Student code (unique per organization)
  dateOfBirth    DateTime?
  grade          String?
  schoolName     String? // Current school name
  status         StudentStatus @default(ACTIVE)
  enrollmentDate DateTime      @default(now())

  // Medical and special needs
  medicalInfo      String?
  allergies        String?
  specialNeeds     String?
  emergencyContact String?

  // Enrollment tracking
  previousTuitionCenter String?
  referralSource        String? // How they heard about us

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  parents      ParentStudent[]
  linkRequests ParentLinkRequest[]
  enrollments  Enrollment[]
  waitlist     Waitlist[]
  attendances  Attendance[]
  grades       Grade[]

  @@unique([studentCode, organizationId]) // Code unique per organization
  @@index([organizationId])
  @@index([branchId])
  @@index([userId])
  @@map("students")
}

model Parent {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  occupation             String?
  company                String?
  officePhone            String?
  preferredContactMethod String? // Email, SMS, Phone, WhatsApp
  emergencyContact       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  students     ParentStudent[]
  linkRequests ParentLinkRequest[]

  @@map("parents")
}

model ParentStudent {
  id       Int    @id @default(autoincrement())
  parentId Int
  parent   Parent @relation(fields: [parentId], references: [id], onDelete: Cascade)

  studentId Int
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  relationship String // e.g., "Father", "Mother", "Guardian"
  isPrimary    Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([parentId, studentId])
  @@index([parentId])
  @@index([studentId])
  @@map("parent_student")
}

model ParentLinkRequest {
  id       Int    @id @default(autoincrement())
  parentId Int
  parent   Parent @relation(fields: [parentId], references: [id], onDelete: Cascade)

  studentId Int
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Verification information provided by parent
  studentCode        String
  studentName        String
  studentDateOfBirth DateTime

  // Relationship information
  relationship String // e.g., "Father", "Mother", "Guardian"

  // Request status and tracking
  status          ParentLinkRequestStatus @default(PENDING)
  rejectionReason String? // Reason if rejected
  approvedBy      Int? // User ID of admin who approved
  approvedByUser  User?                   @relation(fields: [approvedBy], references: [id], onDelete: SetNull)
  approvedAt      DateTime?
  rejectedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([parentId, studentId]) // One active request per parent-student pair
  @@index([parentId])
  @@index([studentId])
  @@index([status])
  @@map("parent_link_requests")
}

model Teacher {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant: Each teacher belongs to an organization
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id])

  teacherCode String // Teacher code (unique per organization)

  // Subject Specialization
  primarySubjects   String? // JSON array: ["Mathematics", "Physics"]
  secondarySubjects String? // JSON array: ["Chemistry"]
  gradeLevels       String? // JSON array: ["Primary 5", "Primary 6", "Secondary 1"]
  languagesSpoken   String? // JSON array: ["English", "Mandarin", "Malay"]

  // Professional Qualifications
  highestQualification String? // e.g., "Bachelor's Degree", "Master's Degree", "PhD"
  degreeName           String? // e.g., "Bachelor of Science in Mathematics"
  institution          String? // e.g., "National University of Singapore"
  graduationYear       Int? // e.g., 2015
  certifications       String? // JSON array: [{"name": "MOE Teaching Cert", "year": 2016}]

  // Employment Details
  employmentType    String? // "Full-time", "Part-time", "Contract", "Freelance"
  contractStartDate DateTime?
  contractEndDate   DateTime?
  workSchedule      String? // JSON object: {"monday": ["09:00-12:00", "14:00-17:00"], ...}
  hourlyRate        Float? // For part-time/freelance teachers
  monthlySalary     Float? // For full-time teachers

  // Professional Profile
  bio                String? // Brief biography
  teachingPhilosophy String? // Teaching approach and philosophy
  achievements       String? // Notable achievements
  specialization     String? // Legacy field - keep for backward compatibility
  qualifications     String? // Legacy field - keep for backward compatibility
  experience         Int? // years of experience

  // Document References
  resumeUrl         String? // URL to resume/CV
  certificatesUrl   String? // URL to certificates folder
  documentsMetadata String? // JSON metadata about uploaded documents

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  classes          Class[]
  coTeacherClasses Class[]        @relation("CoTeacherClasses")
  attendances      Attendance[]
  documents        Document[]
  leaveRequests    LeaveRequest[]

  @@unique([teacherCode, organizationId]) // Code unique per organization
  @@index([organizationId])
  @@index([branchId])
  @@map("teachers")
}

model Document {
  id Int @id @default(autoincrement())

  // Teacher relation
  teacherId Int
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // Document metadata
  documentType DocumentType
  description  String?
  fileName     String // Original file name
  storedName   String // Unique stored file name (with timestamp)
  fileUrl      String // Full URL or path to file
  fileSize     Int // Size in bytes
  mimeType     String // e.g., "application/pdf", "image/jpeg"

  // Expiry tracking
  expiryDate    DateTime? // When the document expires
  expiryAlerted Boolean   @default(false) // Whether expiry alert was sent

  // Upload information
  uploadedBy   Int? // User ID who uploaded
  uploadedUser User?    @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)
  uploadedAt   DateTime @default(now())

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId])
  @@index([documentType])
  @@index([expiryDate])
  @@index([uploadedAt])
  @@map("documents")
}

// Course - Organization-level course catalog (can be template or actual course)
model Course {
  id             Int          @id @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Basic Information
  name        String // e.g., "Matematik SPM", "English UPSR"
  code        String // e.g., "MATH-SPM", "ENG-UPSR"
  description String? @db.Text
  objectives  String? @db.Text // Learning outcomes

  // Categorization
  category        CourseCategory
  difficultyLevel DifficultyLevel

  // Grade Levels - Store as JSON array for multiple levels
  // e.g., ["FORM_4", "FORM_5"] or ["STANDARD_4", "STANDARD_5", "STANDARD_6"]
  gradeLevels Json // Array of CourseLevel enums

  // Age range (optional)
  minAge Int?
  maxAge Int?

  // Prerequisites
  prerequisites String? @db.Text // Description of prerequisites

  // Duration and Scheduling
  sessionDuration SessionDuration
  totalWeeks      Int? // Total duration in weeks (null for ongoing)
  isOngoing       Boolean         @default(true) // True for continuous courses

  // Default Capacity
  maxClassSize Int @default(30) // Default maximum students per class
  minClassSize Int @default(5) // Minimum students to run class

  // Pricing (in Malaysian Ringgit - RM)
  // These are default prices, can be customized per branch
  baseFeePerSession Decimal? @db.Decimal(10, 2)
  baseFeePerMonth   Decimal? @db.Decimal(10, 2)
  baseFeePerTerm    Decimal? @db.Decimal(10, 2)
  materialFee       Decimal? @db.Decimal(10, 2)
  registrationFee   Decimal? @db.Decimal(10, 2)
  trialSessionFee   Decimal? @db.Decimal(10, 2)

  // Materials
  textbooks           Json? // Array of textbook objects
  additionalMaterials String? @db.Text
  digitalResources    String? @db.Text // URLs to resources

  // Availability
  isActive         Boolean @default(true)
  enrollmentOpen   Boolean @default(true)
  waitlistEnabled  Boolean @default(true)
  publicVisibility Boolean @default(true) // Show on website/parent portal

  // Template flag
  isTemplate Boolean @default(false) // True if this is a template for branches to adopt

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  courseBranches CourseBranch[] // Which branches offer this course
  classes        Class[]
  fees           Fee[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([category])
  @@index([isActive])
  @@index([isTemplate])
  @@map("courses")
}

model Room {
  id Int @id @default(autoincrement())

  // Multi-tenant: Each room belongs to an organization
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id])

  name       String
  capacity   Int
  facilities String? // JSON string of facilities

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  classes Class[]

  @@index([organizationId])
  @@index([branchId])
  @@map("rooms")
}

model Class {
  id Int @id @default(autoincrement())

  // Multi-tenant: Each class belongs to an organization
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id])

  courseId Int
  course   Course @relation(fields: [courseId], references: [id])

  // Primary teacher (required)
  teacherId Int
  teacher   Teacher @relation(fields: [teacherId], references: [id])

  // Optional co-teacher/assistant
  coTeacherId Int?
  coTeacher   Teacher? @relation("CoTeacherClasses", fields: [coTeacherId], references: [id])

  roomId Int?
  room   Room? @relation(fields: [roomId], references: [id])

  // Basic Information
  name      String // e.g., "Mathematics - Primary 5 A"
  classCode String // Auto-generated: MATH-P5-A-2026

  // Class Configuration
  classType  ClassType
  classLevel String? // Grade level (e.g., "Primary 5", "Form 3")

  // Term/Semester
  termName      String? // e.g., "Term 1 2026", "Semester 1"
  academicYear  Int? // e.g., 2026
  startDate     DateTime
  endDate       DateTime
  totalWeeks    Int? // Number of teaching weeks
  holidayBreaks Json? // Array of holiday break periods

  // Schedule (recurring pattern)
  schedule      Json // Weekly schedule pattern: [{day: "MONDAY", startTime: "14:00", endTime: "16:00"}]
  scheduleNotes String? // Special notes about schedule

  // Capacity Management
  maxCapacity       Int @default(30) // Maximum students
  minCapacity       Int @default(5) // Minimum students to run
  currentEnrollment Int @default(0) // Current number of enrolled students

  // Fee Structure (per student, can override course defaults)
  feePerSession Decimal? @db.Decimal(10, 2)
  feePerMonth   Decimal? @db.Decimal(10, 2)
  feePerTerm    Decimal? @db.Decimal(10, 2)
  materialFee   Decimal? @db.Decimal(10, 2)

  // Class Settings
  allowLateEnrollment      Boolean   @default(true)
  lateEnrollmentCutoffDate DateTime?
  allowMidTermWithdrawal   Boolean   @default(true)
  waitlistEnabled          Boolean   @default(true)
  autoEnrollFromWaitlist   Boolean   @default(false)

  // Status
  status       ClassStatus @default(DRAFT)
  statusReason String? // Reason for status (e.g., cancellation reason)

  // Materials and Resources
  syllabus           String? // Curriculum/syllabus details
  materials          Json? // Required materials
  digitalResources   String? // Links to digital resources
  classAnnouncements String? // Class announcements

  // Tracking
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  enrollments Enrollment[]
  waitlist    Waitlist[]
  attendances Attendance[]
  assignments Assignment[]
  grades      Grade[]

  @@unique([classCode, organizationId]) // Code unique per organization
  @@index([organizationId])
  @@index([branchId])
  @@index([courseId])
  @@index([teacherId])
  @@index([coTeacherId])
  @@index([status])
  @@index([startDate])
  @@map("classes")
}

model Enrollment {
  id        Int     @id @default(autoincrement())
  studentId Int
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  classId Int
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  enrollmentDate DateTime         @default(now())
  status         EnrollmentStatus @default(ACTIVE)

  // Withdrawal/Transfer tracking
  withdrawalDate       DateTime?
  withdrawalReason     String? // Reason for withdrawal
  transferredToClassId Int? // If transferred to another class

  // Leave tracking
  leaveStartDate DateTime?
  leaveEndDate   DateTime?
  leaveReason    String?

  // Fee tracking
  agreedFeePerMonth Decimal? @db.Decimal(10, 2) // Fee agreed at enrollment
  discountApplied   Decimal? @db.Decimal(10, 2) // Any discount given

  // Notes
  enrollmentNotes String? // Special notes about this enrollment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invoices Invoice[]

  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
  @@index([status])
  @@map("enrollments")
}

model Waitlist {
  id        Int     @id @default(autoincrement())
  studentId Int
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  classId Int
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  // Waitlist tracking
  position    Int // Position in waitlist (1 = first in line)
  requestDate DateTime       @default(now())
  status      WaitlistStatus @default(WAITING)

  // Offer tracking
  offerSentDate       DateTime?
  offerExpiryDate     DateTime?
  offerResponseDate   DateTime?
  offerResponseReason String? // Reason for accepting/declining

  // Enrollment tracking (if accepted and enrolled)
  enrolledDate DateTime?

  // Priority flags
  isPriority    Boolean @default(false) // Priority waitlist (e.g., returning students)
  priorityNotes String? // Reason for priority

  // Notification tracking
  lastNotifiedDate  DateTime?
  notificationCount Int       @default(0)

  // Notes
  notes String? // Admin notes about this waitlist entry

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, classId]) // One waitlist entry per student per class
  @@index([studentId])
  @@index([classId])
  @@index([status])
  @@index([position])
  @@map("waitlist")
}

model Attendance {
  id      Int   @id @default(autoincrement())
  classId Int
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  studentId Int
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  teacherId Int
  teacher   Teacher @relation(fields: [teacherId], references: [id])

  date    DateTime
  status  AttendanceStatus
  remarks String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, studentId, date])
  @@index([classId])
  @@index([studentId])
  @@index([date])
  @@map("attendances")
}

model Assignment {
  id      Int   @id @default(autoincrement())
  classId Int
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  title       String
  description String?
  dueDate     DateTime
  maxScore    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([classId])
  @@map("assignments")
}

model Grade {
  id        Int     @id @default(autoincrement())
  studentId Int
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  classId Int
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  assessment String // e.g., "Quiz 1", "Final Exam"
  score      Float
  maxScore   Float
  grade      String? // e.g., "A", "B+"
  remarks    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([classId])
  @@map("grades")
}

model Fee {
  id Int @id @default(autoincrement())

  // Multi-tenant: Each fee belongs to an organization
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  courseId Int
  course   Course @relation(fields: [courseId], references: [id])

  name        String
  amount      Float
  frequency   String // e.g., "monthly", "term", "one-time"
  description String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([courseId])
  @@map("fees")
}

model Invoice {
  id Int @id @default(autoincrement())

  // Multi-tenant: Each invoice belongs to an organization
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  enrollmentId Int
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])

  invoiceNumber String // Invoice number (unique per organization)
  amount        Float
  dueDate       DateTime
  status        PaymentStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  payments Payment[]

  @@unique([invoiceNumber, organizationId]) // Invoice number unique per organization
  @@index([organizationId])
  @@index([enrollmentId])
  @@index([status])
  @@map("invoices")
}

model Payment {
  id Int @id @default(autoincrement())

  // Multi-tenant: Each payment belongs to an organization
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  amount        Float
  paymentMethod String // e.g., "cash", "card", "bank_transfer"
  paymentDate   DateTime @default(now())
  reference     String?
  remarks       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([invoiceId])
  @@index([paymentDate])
  @@map("payments")
}

model LeaveRequest {
  id Int @id @default(autoincrement())

  // Teacher relation
  teacherId Int
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // Leave details
  leaveType LeaveType
  startDate DateTime
  endDate   DateTime
  totalDays Int // Calculated number of leave days

  // Request information
  reason               String // Reason for leave
  supportingDocuments  String? // Additional documentation info
  affectsClasses       Boolean @default(false) // Whether this leave affects scheduled classes
  affectedClassDetails String? // JSON: details of affected classes if any

  // Status and approval
  status        LeaveStatus @default(PENDING)
  adminComments String? // Comments from admin when approving/rejecting

  // Review tracking
  reviewedByUserId Int? // User ID of admin who reviewed
  reviewedBy       User?     @relation(fields: [reviewedByUserId], references: [id], onDelete: SetNull)
  reviewedAt       DateTime? // When the leave was approved/rejected

  // Submission tracking (for admin submitting on behalf of teacher)
  submittedBy Int? // If null, teacher submitted themselves

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId])
  @@index([status])
  @@index([leaveType])
  @@index([startDate])
  @@index([endDate])
  @@map("leave_requests")
}

// Audit Log for security events
model AuditLog {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())

  // Event classification
  eventType String // LOGIN_SUCCESS, LOGIN_FAILURE, LOGOUT, etc.
  severity  String // INFO, WARNING, ERROR, CRITICAL

  // Event details
  message  String
  metadata Json? // Additional event data

  // User context
  userId         Int?
  userEmail      String?
  organizationId Int?

  // Device/session context
  ipAddress   String?
  userAgent   String?
  fingerprint String? // Browser fingerprint hash

  @@index([eventType])
  @@index([severity])
  @@index([userId])
  @@index([organizationId])
  @@index([timestamp])
  @@index([userEmail])
  @@map("audit_logs")
}

// CourseBranch - Junction table for Course-Branch relationship with customization
model CourseBranch {
  id       Int    @id @default(autoincrement())
  courseId Int
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // Branch-specific customization
  isOffered Boolean @default(true) // Whether this branch offers this course

  // Custom pricing for this branch (overrides course default if set)
  customFeePerSession   Decimal? @db.Decimal(10, 2)
  customFeePerMonth     Decimal? @db.Decimal(10, 2)
  customFeePerTerm      Decimal? @db.Decimal(10, 2)
  customMaterialFee     Decimal? @db.Decimal(10, 2)
  customRegistrationFee Decimal? @db.Decimal(10, 2)

  // Custom capacity for this branch (overrides course default if set)
  customMaxClassSize Int?
  customMinClassSize Int?

  // Branch-specific notes
  branchNotes String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, branchId])
  @@index([branchId])
  @@index([courseId])
  @@index([isOffered])
  @@map("course_branches")
}
